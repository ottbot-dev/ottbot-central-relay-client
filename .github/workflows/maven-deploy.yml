# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven
#
# This file is auto-generated by OpenAPI Generator (https://openapi-generator.tech)

name: Deploy package

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    name: Build OpenAPI definition
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
        cache: maven

    - name: Increment Version
      id: increment_version
      run: |
        # Extract current version from pom.xml
        CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        
        # Increment version (this example increments patch version)
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' OFS=.)
        
        # Update pom.xml with new version
        mvn versions:set -DnewVersion=$NEW_VERSION
        
        # Output the new version for potential use in later steps
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Commit Version Increment
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add pom.xml
        git commit -m "chore:Bump version to ${{ steps.increment_version.outputs.new_version }}"
        git push

    - name: Create and Push Tag
      run: |
        git tag v${{ steps.increment_version.outputs.new_version }}
        git push origin v${{ steps.increment_version.outputs.new_version }}

    - name: Publish to GitHub Packages Apache Maven
      run: mvn deploy
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_TOKEN: ${{ github.token }}
